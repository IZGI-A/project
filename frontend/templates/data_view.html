{% extends "base.html" %}
{% block title %}Data View - {{ tenant_name }}{% endblock %}

{% block extra_css %}
<style>
    /* Column offcanvas — only colors, no positioning overrides */
    #colOffcanvas {
        background: rgba(30,27,75,0.98) !important;
        border-left: 1px solid rgba(255,255,255,0.1);
    }
    #colOffcanvas .offcanvas-header {
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .col-item {
        transition: background 0.15s ease;
        border-radius: 6px;
    }
    .col-item:hover {
        background: rgba(255,255,255,0.06);
    }
    .filter-meta-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
    }
    @media (max-width: 767.98px) {
        /* Mobile filter: grid layout */
        #filterForm {
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            align-items: center;
        }
        #filterForm > input[type="hidden"] { display: none; }
        #filterForm > .flex-fill { width: 100%; }
        #filterForm .form-select { width: 100%; min-width: 0 !important; font-size: 0.85rem; }
        #filterForm > button[type="submit"] { grid-column: 1 / -1; }
        #filterForm > #sortBadge { grid-column: 1 / -1; }
        .filter-meta-row {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<h4 class="page-title mb-4 text-glow">Data Warehouse Viewer</h4>

<!-- Filters -->
<div class="mb-3" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; max-width: 100%;">
    <div class="card-body py-2 px-3">
        <form id="filterForm" method="get" class="d-flex gap-2 gap-md-3 align-items-center flex-wrap">
            <input type="hidden" name="columns" id="hiddenColumns" value="{{ selected_columns }}">
            <div class="flex-fill flex-md-grow-0">
                <select name="loan_type" class="form-select form-select-sm" style="border-radius: 8px;">
                    <option value="RETAIL" {% if loan_type == "RETAIL" %}selected{% endif %}>Retail</option>
                    <option value="COMMERCIAL" {% if loan_type == "COMMERCIAL" %}selected{% endif %}>Commercial</option>
                </select>
            </div>
            <div class="flex-fill flex-md-grow-0">
                <select name="data_type" class="form-select form-select-sm" style="border-radius: 8px;">
                    <option value="credit" {% if data_type == "credit" %}selected{% endif %}>Credits</option>
                    <option value="payment" {% if data_type == "payment" %}selected{% endif %}>Payments</option>
                </select>
            </div>
            <button type="submit" class="btn btn-accent btn-sm" style="border-radius: 8px;">
                <i class="bi bi-search"></i> Filter
            </button>

            <!-- Sort info badge -->
            <span id="sortBadge" class="d-none" style="font-size: 0.8rem; color: var(--accent-cyan); cursor: pointer;"
                  title="Click to clear sorting">
            </span>

            <!-- Row count + Column selector trigger -->
            <div class="filter-meta-row">
                <span class="text-nowrap" style="color: var(--text-secondary); font-size: 0.8rem;">
                    <i class="bi bi-database"></i> <strong id="totalCount" style="color: var(--accent-cyan);">0</strong> <span class="d-none d-sm-inline">rows</span>
                </span>
                {% if all_columns %}
                <button class="btn btn-glass btn-sm" type="button"
                        data-bs-toggle="offcanvas" data-bs-target="#colOffcanvas"
                        style="border-radius: 8px;">
                    <i class="bi bi-layout-three-columns"></i>
                    <span class="d-none d-sm-inline">Columns</span>
                    <span class="badge badge-glass ms-1" id="colCountBadge">{{ columns|length }}</span>
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- Column Selector Offcanvas (Bootstrap managed — works on all devices) -->
{% if all_columns %}
<div class="offcanvas offcanvas-end" tabindex="-1" id="colOffcanvas" aria-labelledby="colOffcanvasLabel">
    <div class="offcanvas-header">
        <h6 class="offcanvas-title" id="colOffcanvasLabel" style="font-weight: 600;">
            <i class="bi bi-layout-three-columns me-1" style="color: var(--accent-cyan);"></i> Select Columns
        </h6>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <input type="text" id="colSearch" class="form-control form-control-sm mb-3"
               placeholder="Search columns..." autocomplete="off"
               style="border-radius: 8px; font-size: 0.85rem;">
        <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-glass btn-sm flex-fill" id="selectAllBtn"
                    style="font-size: 0.8rem; border-radius: 8px;">
                <i class="bi bi-check-all"></i> Select All
            </button>
            <button type="button" class="btn btn-glass btn-sm flex-fill" id="deselectAllBtn"
                    style="font-size: 0.8rem; border-radius: 8px;">
                <i class="bi bi-x-lg"></i> Deselect All
            </button>
        </div>
        <div id="colListWrap" style="overflow-y: auto; max-height: calc(100vh - 250px);">
            {% for col in all_columns %}
            <label class="col-item d-flex align-items-center gap-2 px-2 py-1"
                   data-colname="{{ col }}"
                   style="font-size: 0.85rem; color: #e2e8f0; cursor: pointer;">
                <input type="checkbox" class="form-check-input col-checkbox"
                       value="{{ col }}"
                       {% if col in columns %}checked{% endif %}
                       style="margin: 0;">
                <span>{{ col }}</span>
            </label>
            {% endfor %}
        </div>
        <div class="mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.08);">
            <button type="button" class="btn btn-accent w-100" id="applyColumnsBtn"
                    style="border-radius: 8px;">
                <i class="bi bi-check-lg"></i> Apply Columns
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Table -->
<div id="dataTable" class="glass-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-glass table-hover" id="mainTable">
                <thead><tr id="tableHead"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Server-side Pagination -->
{% if total_pages > 1 %}
<nav class="mt-3" id="paginationNav">
    <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
        <ul class="pagination pagination-sm mb-0">
            {% if page > 1 %}
            <li class="page-item"><a class="page-link" href="?loan_type={{ loan_type }}&data_type={{ data_type }}&columns={{ selected_columns }}&page={{ page|add:"-1" }}&page_size={{ page_size }}&sort={{ sort_col }}&dir={{ sort_dir }}" style="border-radius:8px 0 0 8px;"><i class="bi bi-chevron-left"></i></a></li>
            {% endif %}
            {% for p in page_range %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="?loan_type={{ loan_type }}&data_type={{ data_type }}&columns={{ selected_columns }}&page={{ p }}&page_size={{ page_size }}&sort={{ sort_col }}&dir={{ sort_dir }}">{{ p }}</a>
            </li>
            {% endfor %}
            {% if page < total_pages %}
            <li class="page-item"><a class="page-link" href="?loan_type={{ loan_type }}&data_type={{ data_type }}&columns={{ selected_columns }}&page={{ page|add:"1" }}&page_size={{ page_size }}&sort={{ sort_col }}&dir={{ sort_dir }}" style="border-radius:0 8px 8px 0;"><i class="bi bi-chevron-right"></i></a></li>
            {% endif %}
        </ul>
        <select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto; border-radius: 8px; font-size: 0.8rem;">
            <option value="50" {% if page_size == 50 %}selected{% endif %}>50 / page</option>
            <option value="100" {% if page_size == 100 %}selected{% endif %}>100 / page</option>
            <option value="200" {% if page_size == 200 %}selected{% endif %}>200 / page</option>
            <option value="500" {% if page_size == 500 %}selected{% endif %}>500 / page</option>
        </select>
        <span style="color: var(--text-secondary); font-size: 0.8rem;">
            Page {{ page }} / {{ total_pages }}
        </span>
    </div>
</nav>
{% endif %}

<script>
(function() {
    var COLUMNS = {{ columns_json|safe }};
    var PAGE_DATA = {{ data_json|safe }};
    var SORT_COL = '{{ sort_col }}';
    var SORT_DIR = '{{ sort_dir }}';

    var thead = document.getElementById('tableHead');
    var tbody = document.getElementById('tableBody');
    var totalEl = document.getElementById('totalCount');
    var sortBadge = document.getElementById('sortBadge');

    totalEl.textContent = '{{ total_rows }}';

    // ── Build header with server-side sort links ──
    function renderHead() {
        thead.innerHTML = '';
        COLUMNS.forEach(function(col) {
            var th = document.createElement('th');
            th.className = 'text-nowrap';
            th.style.cursor = 'pointer';
            th.style.userSelect = 'none';

            var icon = '';
            if (col === SORT_COL) {
                var arrow = SORT_DIR === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down';
                icon = ' <i class="bi ' + arrow + '" style="color:#22d3ee;font-size:0.85rem;font-weight:700;text-shadow:0 0 6px rgba(34,211,238,0.5);"></i>';
            } else {
                icon = ' <i class="bi bi-arrow-down-up" style="color:rgba(148,163,184,0.35);font-size:0.7rem;"></i>';
            }

            th.innerHTML = '<span style="color:#e2e8f0;">' + col + '</span>' + icon;
            th.addEventListener('click', function() {
                var newDir = (col === SORT_COL && SORT_DIR === 'asc') ? 'desc' : 'asc';
                var params = new URLSearchParams(window.location.search);
                params.set('sort', col);
                params.set('dir', newDir);
                params.set('page', '1');
                window.location.search = params.toString();
            });
            thead.appendChild(th);
        });
    }

    // ── Sort badge ──
    if (SORT_COL) {
        sortBadge.innerHTML = '<i class="bi bi-sort-alpha-down me-1"></i>Sort: ' + SORT_COL + ' ' + SORT_DIR.toUpperCase() +
            ' <i class="bi bi-x-circle" style="color:var(--accent-red);margin-left:4px;"></i>';
        sortBadge.classList.remove('d-none');
        sortBadge.addEventListener('click', function() {
            var params = new URLSearchParams(window.location.search);
            params.delete('sort');
            params.delete('dir');
            params.set('page', '1');
            window.location.search = params.toString();
        });
    }

    // ── Render table body (only current page data from server) ──
    function renderBody() {
        var html = '';
        if (PAGE_DATA.length === 0) {
            html = '<tr><td colspan="' + COLUMNS.length + '" class="text-secondary text-center py-4">No data</td></tr>';
        } else {
            for (var r = 0; r < PAGE_DATA.length; r++) {
                html += '<tr>';
                var row = PAGE_DATA[r];
                for (var c = 0; c < row.length; c++) {
                    var v = row[c];
                    html += '<td class="text-nowrap"><small>' + (v !== null && v !== '' ? v : '-') + '</small></td>';
                }
                html += '</tr>';
            }
        }
        tbody.innerHTML = html;
    }

    // ── Page size change ──
    var pagSizeSel = document.getElementById('pageSizeSelect');
    if (pagSizeSel) {
        pagSizeSel.addEventListener('change', function() {
            var params = new URLSearchParams(window.location.search);
            params.set('page_size', this.value);
            params.set('page', '1');
            window.location.search = params.toString();
        });
    }

    // ── Column selector ──
    var form = document.getElementById('filterForm');
    var hiddenCols = document.getElementById('hiddenColumns');
    var checkboxes = document.querySelectorAll('.col-checkbox');
    var colCountBadge = document.getElementById('colCountBadge');

    function updateColCount() {
        var n = document.querySelectorAll('.col-checkbox:checked').length;
        if (colCountBadge) colCountBadge.textContent = n;
    }

    checkboxes.forEach(function(cb) { cb.addEventListener('change', updateColCount); });

    var selAll = document.getElementById('selectAllBtn');
    if (selAll) selAll.addEventListener('click', function() {
        checkboxes.forEach(function(cb){ cb.checked = true; });
        updateColCount();
    });

    var deselAll = document.getElementById('deselectAllBtn');
    if (deselAll) deselAll.addEventListener('click', function() {
        checkboxes.forEach(function(cb){ cb.checked = false; });
        updateColCount();
    });

    var applyBtn = document.getElementById('applyColumnsBtn');
    if (applyBtn) {
        applyBtn.addEventListener('click', function() {
            var sel = Array.from(document.querySelectorAll('.col-checkbox:checked')).map(function(cb){ return cb.value; });
            hiddenCols.value = sel.join(',');
            var offcanvasEl = document.getElementById('colOffcanvas');
            if (offcanvasEl) {
                var bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                if (bsOffcanvas) bsOffcanvas.hide();
            }
            form.submit();
        });
    }

    // ── Initial render ──
    renderHead();
    renderBody();
})();
</script>
<script>
// Column search
(function() {
    var searchInput = document.getElementById('colSearch');
    if (!searchInput) return;
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') e.preventDefault();
    });
    searchInput.addEventListener('input', function() {
        var q = this.value.toLowerCase();
        var items = document.querySelectorAll('.col-item');
        for (var i = 0; i < items.length; i++) {
            var name = items[i].getAttribute('data-colname') || '';
            items[i].style.display = name.toLowerCase().indexOf(q) >= 0 ? '' : 'none';
        }
    });
})();
</script>
{% endblock %}
