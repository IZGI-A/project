{% load static %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Financial Data Adapter{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* ── Glassmorphism Design System ── */
        :root {
            --glass-bg: rgba(255,255,255,0.07);
            --glass-bg-light: rgba(255,255,255,0.05);
            --glass-bg-hover: rgba(255,255,255,0.12);
            --glass-border: rgba(255,255,255,0.1);
            --glass-border-light: rgba(255,255,255,0.06);
            --accent-purple: #7c3aed;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }

        /* ── Glass Components ── */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            max-width: 100%;
        }

        .glass-card {
            background: var(--glass-bg-light);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            overflow: hidden;
        }

        .glass-sidebar {
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border-light);
        }

        /* ── Sidebar ── */
        .sidebar {
            min-height: 100vh;
            width: 250px;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
        }

        .sidebar .brand {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--glass-border-light);
        }

        .sidebar .brand h6 {
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.05rem;
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 0.65rem 1rem;
            border-radius: 10px;
            margin: 2px 10px;
            font-size: 0.88rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-link:hover {
            color: var(--text-primary);
            background: var(--glass-bg-hover);
        }

        .sidebar .nav-link.active {
            color: #fff;
            background: rgba(124,58,237,0.15);
            border-left-color: var(--accent-purple);
        }

        .sidebar .nav-link i {
            width: 22px;
            margin-right: 8px;
            font-size: 1rem;
        }

        .main-content {
            margin-left: 250px;
            width: calc(100% - 250px);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ── Typography ── */
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        .text-glow {
            text-shadow: 0 0 20px rgba(124,58,237,0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .accent-gradient {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
        }

        /* ── Tables ── */
        .table-glass {
            --bs-table-bg: transparent;
            --bs-table-color: var(--text-primary);
            --bs-table-border-color: var(--glass-border-light);
            --bs-table-striped-bg: rgba(255,255,255,0.03);
            --bs-table-hover-bg: rgba(255,255,255,0.06);
            margin-bottom: 0;
            font-size: 0.85rem;
        }

        .table-glass thead {
            background: rgba(255,255,255,0.08);
        }

        .table-glass thead th {
            font-weight: 600;
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom-color: var(--glass-border);
            padding: 0.6rem 0.75rem;
        }

        .table-glass td {
            padding: 0.5rem 0.75rem;
            vertical-align: middle;
        }

        /* ── Buttons ── */
        .btn-glass {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text-primary);
            backdrop-filter: blur(8px);
            transition: all 0.2s ease;
        }

        .btn-glass:hover {
            background: rgba(255,255,255,0.18);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }

        .btn-accent {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            border: none;
            color: #fff;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-accent:hover {
            opacity: 0.9;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(124,58,237,0.4);
        }

        /* ── Badges ── */
        .badge-glass {
            background: rgba(124,58,237,0.2);
            color: #a78bfa;
            border: 1px solid rgba(124,58,237,0.3);
            font-weight: 500;
        }

        .badge-success-glass {
            background: rgba(16,185,129,0.15);
            color: #34d399;
            border: 1px solid rgba(16,185,129,0.3);
        }

        .badge-danger-glass {
            background: rgba(239,68,68,0.15);
            color: #f87171;
            border: 1px solid rgba(239,68,68,0.3);
        }

        .badge-warning-glass {
            background: rgba(245,158,11,0.15);
            color: #fbbf24;
            border: 1px solid rgba(245,158,11,0.3);
        }

        .badge-info-glass {
            background: rgba(6,182,212,0.15);
            color: #22d3ee;
            border: 1px solid rgba(6,182,212,0.3);
        }

        .badge-secondary-glass {
            background: rgba(148,163,184,0.15);
            color: #cbd5e1;
            border: 1px solid rgba(148,163,184,0.2);
        }

        /* ── Forms ── */
        .form-control, .form-select {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: var(--text-primary);
        }

        .form-control:focus, .form-select:focus {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 0.2rem rgba(124,58,237,0.25);
            color: #fff;
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .form-text {
            color: var(--text-secondary) !important;
        }

        /* ── Alerts ── */
        .alert-glass-success {
            background: rgba(16,185,129,0.1);
            border: 1px solid rgba(16,185,129,0.3);
            color: #34d399;
            border-radius: 12px;
        }

        .alert-glass-danger {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: #f87171;
            border-radius: 12px;
        }

        .alert-glass-info {
            background: rgba(6,182,212,0.1);
            border: 1px solid rgba(6,182,212,0.3);
            color: #22d3ee;
            border-radius: 12px;
        }

        /* ── Quality Bars ── */
        .quality-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.08);
        }

        .quality-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

        /* ── Pagination ── */
        .page-link {
            background: rgba(255,255,255,0.06);
            border-color: var(--glass-border);
            color: var(--text-secondary);
        }

        .page-link:hover {
            background: rgba(255,255,255,0.12);
            border-color: var(--glass-border);
            color: #fff;
        }

        .page-item.active .page-link {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: #fff;
        }

        /* ── Modal ── */
        .modal-content {
            background: rgba(30,27,75,0.97);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
        }

        .modal-header {
            border-bottom-color: var(--glass-border-light);
        }

        .modal-footer {
            border-top-color: var(--glass-border-light);
        }

        .btn-close {
            filter: invert(1);
        }

        /* ── Stat Card ── */
        .stat-card {
            border: none;
            border-radius: 12px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* ── Nav Pills (Glass) ── */
        .nav-pills-glass .nav-link {
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid transparent;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }

        .nav-pills-glass .nav-link:hover {
            background: rgba(255,255,255,0.08);
            color: var(--text-primary);
        }

        .nav-pills-glass .nav-link.active {
            background: rgba(124,58,237,0.2);
            color: #a78bfa;
            border-color: rgba(124,58,237,0.3);
        }

        /* ── List Group Glass ── */
        .list-group-glass .list-group-item {
            background: transparent;
            border-color: var(--glass-border-light);
            color: var(--text-primary);
        }

        .list-group-glass .list-group-item:hover,
        .list-group-glass .list-group-item-action:hover {
            background: rgba(255,255,255,0.06);
        }

        .list-group-glass .list-group-item.active {
            background: rgba(124,58,237,0.15);
            border-color: rgba(124,58,237,0.3);
            color: #fff;
        }

        /* ── Code ── */
        code {
            color: var(--accent-cyan);
            background: rgba(6,182,212,0.1);
            padding: 0.15em 0.4em;
            border-radius: 4px;
            font-size: 0.82rem;
        }

        /* ── Card Header (glass) ── */
        .glass-card .card-header, .glass .card-header {
            background: rgba(255,255,255,0.04);
            border-bottom: 1px solid var(--glass-border-light);
        }

        /* ── Sidebar transition (base) ── */
        .sidebar {
            transition: transform 0.3s ease, width 0.2s ease;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active { display: block; }

        .mobile-header {
            display: none;
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(15,12,41,0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--glass-border-light);
            padding: 0.6rem 1rem;
        }

        .mobile-header .hamburger {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            padding: 0.25rem;
            cursor: pointer;
        }

        /* ── Responsive — Mobile (< 768px) ── */
        @media (max-width: 767.98px) {
            .sidebar {
                transform: translateX(-100%);
                width: 250px;
                z-index: 200;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                min-width: 0;
            }
            .mobile-header { display: flex; align-items: center; gap: 0.75rem; }
            .page-title { font-size: 1.25rem; }
            .stat-value { font-size: 1.5rem; }
            .container-fluid { padding: 0.75rem !important; }
            .table-glass { font-size: 0.78rem; }
            .table-glass thead th { font-size: 0.7rem; padding: 0.45rem 0.5rem; }
            .table-glass td { padding: 0.4rem 0.5rem; }
            /* Ensure cards don't push content wider than viewport */
            .glass-card, .glass { min-width: 0; max-width: 100%; }
            .row { margin-left: -0.375rem; margin-right: -0.375rem; }
            .row > * { padding-left: 0.375rem; padding-right: 0.375rem; }
            /* Table-responsive scroll hint */
            .table-responsive { -webkit-overflow-scrolling: touch; }
            /* Prevent any child from overflowing the viewport */
            .container-fluid > * { max-width: 100%; }
        }

        /* ── Responsive — Tablet (768px - 991px) ── */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .sidebar { width: 70px; }
            .sidebar .nav-link span,
            .sidebar .brand small,
            .sidebar .brand h6 span { display: none; }
            .sidebar .nav-link { padding: 0.65rem 0; justify-content: center; }
            .sidebar .nav-link i { margin-right: 0; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); }
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
{% if tenant_id %}
<div>
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="hamburger" id="sidebarToggle" aria-label="Toggle menu">
            <i class="bi bi-list"></i>
        </button>
        <h6 class="mb-0" style="font-weight: 700; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 0.95rem;">
            <i class="bi bi-bank2" style="-webkit-text-fill-color: var(--accent-purple);"></i> FinData Adapter
        </h6>
        <small class="text-secondary ms-auto" style="font-size: 0.75rem;">{{ tenant_name }}</small>
    </div>

    <!-- Sidebar -->
    <div class="sidebar glass-sidebar d-flex flex-column" id="sidebar">
        <div class="brand">
            <h6 class="mb-0"><i class="bi bi-bank2"></i> <span>FinData Adapter</span></h6>
            <small class="text-secondary">{{ tenant_name }}</small>
        </div>
        <nav class="nav flex-column flex-grow-1 py-2">
            <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'frontend:dashboard' %}">
                <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
            <a class="nav-link {% if 'upload' in request.path %}active{% endif %}" href="{% url 'frontend:upload' %}">
                <i class="bi bi-cloud-upload"></i> <span>Upload CSV</span>
            </a>
            <a class="nav-link {% if 'sync' in request.path and 'trigger' not in request.path %}active{% endif %}" href="{% url 'frontend:sync' %}">
                <i class="bi bi-arrow-repeat"></i> <span>Sync</span>
            </a>
            <a class="nav-link {% if 'data' in request.path %}active{% endif %}" href="{% url 'frontend:data-view' %}">
                <i class="bi bi-table"></i> <span>Data View</span>
            </a>
            <a class="nav-link {% if 'profiling' in request.path %}active{% endif %}" href="{% url 'frontend:profiling' %}">
                <i class="bi bi-graph-up"></i> <span>Profiling</span>
            </a>
            <a class="nav-link {% if 'errors' in request.path %}active{% endif %}" href="{% url 'frontend:errors' %}">
                <i class="bi bi-exclamation-triangle"></i> <span>Errors</span>
            </a>
        </nav>
        <div class="py-3 px-2">
            <a class="nav-link {% if 'settings' in request.path %}active{% endif %}" href="{% url 'frontend:settings' %}">
                <i class="bi bi-gear"></i> <span>Settings</span>
            </a>
            <a class="nav-link" href="{% url 'frontend:logout' %}" style="color: #f87171;">
                <i class="bi bi-box-arrow-left"></i> <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid p-4">
            {% block content %}{% endblock %}
        </div>
    </div>
</div>
{% else %}
    {% block public_content %}{% endblock %}
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
// HTMX error handling
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    var status = evt.detail.xhr.status;
    if (status === 401) {
        window.location.href = '/login/';
        evt.detail.shouldSwap = false;
    } else if (status >= 400) {
        evt.detail.shouldSwap = false;
    }
});

// Chart.js global defaults for dark theme
Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
Chart.defaults.plugins.legend.labels.color = '#94a3b8';

// Sidebar toggle (mobile)
(function() {
    var toggle = document.getElementById('sidebarToggle');
    var sidebar = document.getElementById('sidebar');
    var overlay = document.getElementById('sidebarOverlay');
    if (!toggle || !sidebar || !overlay) return;

    function openSidebar() {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeSidebar() {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }
    toggle.addEventListener('click', function() {
        sidebar.classList.contains('open') ? closeSidebar() : openSidebar();
    });
    overlay.addEventListener('click', closeSidebar);

    // Close sidebar when a nav link is clicked (mobile)
    sidebar.querySelectorAll('.nav-link').forEach(function(link) {
        link.addEventListener('click', function() {
            if (window.innerWidth < 768) closeSidebar();
        });
    });
})();
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
