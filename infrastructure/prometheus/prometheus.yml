global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "/etc/prometheus/alert_rules.yml"

scrape_configs:
  # Django Application (django-prometheus auto + custom business metrics)
  - job_name: 'django'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['web:8000']

  # PostgreSQL Exporter
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # ClickHouse Native Metrics
  - job_name: 'clickhouse'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['clickhouse:9363']

  # cAdvisor (Container Metrics)
  # NOTE: macOS Docker Desktop does not expose container names via cAdvisor.
  # metric_relabel_configs maps container IDs to service names.
  # After `docker compose up -d`, regenerate mappings if container IDs change.
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    metric_relabel_configs:
      - source_labels: [id]
        regex: '.*29ad93c314f6.*'
        target_label: service
        replacement: 'web'
      - source_labels: [id]
        regex: '.*107572ba89ff.*'
        target_label: service
        replacement: 'db'
      - source_labels: [id]
        regex: '.*3600cb7b0fb3.*'
        target_label: service
        replacement: 'clickhouse'
      - source_labels: [id]
        regex: '.*779a959fcd80.*'
        target_label: service
        replacement: 'redis'
      - source_labels: [id]
        regex: '.*a71fb0cdf3a4.*'
        target_label: service
        replacement: 'celery-worker'
      - source_labels: [id]
        regex: '.*f33b8ecfd3c3.*'
        target_label: service
        replacement: 'celery-beat'
      - source_labels: [id]
        regex: '.*e293cc6795e9.*'
        target_label: service
        replacement: 'prometheus'
      - source_labels: [id]
        regex: '.*2a1c1244c369.*'
        target_label: service
        replacement: 'grafana'
      - source_labels: [id]
        regex: '.*19c4ad3c0a09.*'
        target_label: service
        replacement: 'cadvisor'
      - source_labels: [id]
        regex: '.*8c8a74dbefd2.*'
        target_label: service
        replacement: 'postgres-exporter'
      - source_labels: [id]
        regex: '.*af858b5ca7c1.*'
        target_label: service
        replacement: 'redis-exporter'

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
