global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "/etc/prometheus/alert_rules.yml"

scrape_configs:
  # Django Application (django-prometheus auto + custom business metrics)
  - job_name: 'django'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['web:8000']

  # PostgreSQL Exporter
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # ClickHouse Native Metrics
  - job_name: 'clickhouse'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['clickhouse:9363']

  # cAdvisor (Container Metrics)
  # NOTE: macOS Docker Desktop does not expose container names via cAdvisor.
  # metric_relabel_configs maps container IDs to service names.
  # After `docker compose up -d`, regenerate mappings if container IDs change.
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    metric_relabel_configs:
      - source_labels: [id]
        regex: '.*58a3fa45a3fb.*'
        target_label: service
        replacement: 'web'
      - source_labels: [id]
        regex: '.*d63ddce72fb1.*'
        target_label: service
        replacement: 'db'
      - source_labels: [id]
        regex: '.*b3646e2125b0.*'
        target_label: service
        replacement: 'clickhouse'
      - source_labels: [id]
        regex: '.*6d1c4a9f4156.*'
        target_label: service
        replacement: 'redis'
      - source_labels: [id]
        regex: '.*08efddca369c.*'
        target_label: service
        replacement: 'airflow-webserver'
      - source_labels: [id]
        regex: '.*feafc45aaabf.*'
        target_label: service
        replacement: 'airflow-scheduler'
      - source_labels: [id]
        regex: '.*3a8d35ab2875.*'
        target_label: service
        replacement: 'prometheus'
      - source_labels: [id]
        regex: '.*62358792b874.*'
        target_label: service
        replacement: 'grafana'
      - source_labels: [id]
        regex: '.*46c65d9859ec.*'
        target_label: service
        replacement: 'cadvisor'
      - source_labels: [id]
        regex: '.*1f941e2485b1.*'
        target_label: service
        replacement: 'postgres-exporter'
      - source_labels: [id]
        regex: '.*9f336357895c.*'
        target_label: service
        replacement: 'redis-exporter'

  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
